#!/usr/bin/env bash

# Fail fast when a command returns non-zero exit code.
set -e
CURRENT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Copy ADB key.
mkdir -p "~/.android"
cp "$CURRENT_DIR/adbkey.pub" "~/.android/adbkey.pub"

# Download emulator.
echo "Installing Android emulator runner."
${CURRENT_DIR}/android-silent-sdkmanager "emulator"

# Print available targets.
echo "Emulator images:"
${CURRENT_DIR}/android-silent-sdkmanager --verbose --list | grep -iP '^(---|system-images).*' \
    | awk '/---/{i++}i-1' | awk '/system-images/{i++}i'

# Download system image.
echo "Installing system image for Android SDK $EMULATOR_ANDROID_SDK (ABI: $EMULATOR_ABI)."
${CURRENT_DIR}/android-silent-sdkmanager "system-images;android-$EMULATOR_ANDROID_SDK;google_apis;$EMULATOR_ABI"

# Print installed targets.
echo "Installed emulator images:"
${CURRENT_DIR}/android-silent-sdkmanager --verbose --list | grep -iP '^(---|system-images).*' \
    | awk '/system-images/{i++}i' | awk '/---/{i--}i+1'

${CURRENT_DIR}/android-update-sdk
