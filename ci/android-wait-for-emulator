#!/bin/bash
# Copied from https://github.com/travis-ci/travis-cookbooks/blob/precise-stable/ci_environment/android-sdk/files/default/android-wait-for-emulator which is released under the MIT license.

# Fail fast when a command returns non-zero exit code.
set -e

BOOT_ANIMATION=""
FAIL_COUNTER=0
TIMEOUT_IN_SECONDS=360

echo "Waiting for emulator to start."
until [[ "$BOOT_ANIMATION" =~ "stopped" ]]
do
    BOOT_ANIMATION=`adb -e shell getprop init.svc.bootanim 2>&1 &`
    if [[ "$BOOT_ANIMATION" =~ "device not found" || "$BOOT_ANIMATION" =~ "device offline" || "$BOOT_ANIMATION" =~ "running" ]]
    then
        let "failcounter += 1"
        echo -ne "\rWaiting for emulator to start ($FAIL_COUNTER seconds)."
        if [[ ${FAIL_COUNTER} -gt timeout_in_sec ]]
        then
            echo "Timeout ($TIMEOUT_IN_SECONDS seconds) reached. Failed to start emulator."
            exit 1
        fi
    elif  [[ "$BOOT_ANIMATION" =~ "stopped" ]]
    then
        echo "Emulator is ready."
    else
        echo "Cannot get device status." 1>&2
        exit -1
    fi
    sleep 1
done
