language: java

jdk: openjdk8

# Execute build in container-based environment.
sudo: false

branches:
  except:
  - gh-pages

env:
  global:
  - ANDROID_HOME=$HOME/android-sdk
  - ANDROID_BUILD_TOOLS=28.0.3
  - ANDROID_SDK=28
  # Add Android SDK tools to path.
  - PATH=$PATH:$ANDROID_HOME/tools
  - PATH=$PATH:$ANDROID_HOME/tools/bin
  - PATH=$PATH:$ANDROID_HOME/platform-tools
  - PATH=$PATH:$ANDROID_HOME/emulator
  # Add CI scripts to path.
  - PATH=$PATH:$PWD/ci

# Install Android SDK before each build (if not already cached).
install: android-install-sdk

stages:
- "Install"
- "Build"
- "Lint"
- "Test"
- "Test Coverage"

jobs:
  include:
  - stage: "Install"
    name: "Install SDK"
    # Only install SDK, don't run any script.
    script: true  > /dev/null
  - stage: "Build"
    name: "Assemble"
    script: android-assemble
  - stage: "Test"
    name: "Lint"
    script: android-lint
  - name: "Unit test"
    script: android-unit-tests
  - name: "Integration test"
    script: android-integration-tests
    env:
      EMULATOR_ANDROID_SDK=28
      EMULATOR_ABI=armeabi-v7a
  - name: "Integration test"
    script: android-integration-tests
    env:
      EMULATOR_ANDROID_SDK=21
      EMULATOR_ABI=armeabi-v7a
  - stage: "Coverage"
    name: "Test coverage"
    script: android-test-coverage

# Use Travis CI's cache management
before_cache:
- rm -f $HOME/.gradle/caches/modules-2/modules-2.lock
- rm -fr $HOME/.gradle/caches/*/plugin-resolution/
cache:
  directories:
  # Android SDK
  - $ANDROID_HOME
  # Gradle dependencies
  - $HOME/.gradle/caches/
  - $HOME/.gradle/wrapper/
  # Android build cache (see http://tools.android.com/tech-docs/build-cache)
  - $HOME/.android/build-cache
