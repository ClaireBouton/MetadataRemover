language: java

jdk: openjdk8

# Execute build in container-based environment.
sudo: false

branches:
  except:
  - gh-pages

env:
  global:
  - ANDROID_HOME=$HOME/android-sdk
  - ANDROID_BUILD_TOOLS=28.0.3
  - ANDROID_SDK=28
  # Add Android SDK tools to path.
  - PATH=$PATH:$ANDROID_HOME/tools:$ANDROID_HOME/tools/bin:$ANDROID_HOME/platform-tools:$ANDROID_HOME/emulator

before_install:
  # Decrypt Google Play publishing key.
  - openssl aes-256-cbc -K $encrypted_a426ff20bb84_key -iv $encrypted_a426ff20bb84_iv -in api-7281121051860956110-977812-57e7308358e6.json.enc -out secret/api-7281121051860956110-977812-57e7308358e6.json -d

# Install Android SDK before each build (if not already cached).
install: ci/android-install-sdk

stages:
- Install
- Build
- Lint
- Test
- Test Coverage

jobs:
  include:
  - stage: Build
    name: Assemble
    script: ci/android-assemble
  - stage: Test
    name: Lint
    script: ci/android-lint
  - name: Unit test
    script: ci/android-unit-tests
  - name: Integration test
    script: ci/android-integration-tests
    env: EMULATOR_ANDROID_SDK=25 EMULATOR_ABI=arm64-v8a
  - name: Integration test
    script: ci/android-integration-tests
    env: EMULATOR_ANDROID_SDK=21 EMULATOR_ABI=armeabi-v7a
  - stage: Coverage
    name: Test coverage
    script: ci/android-test-coverage
  allow_failures:
  - name: Integration test
matrix:
  fast_finish: true

# Use Travis CI's cache management
before_cache:
- rm -f $HOME/.gradle/caches/modules-2/modules-2.lock
- rm -fr $HOME/.gradle/caches/*/plugin-resolution/
cache:
  directories:
  # Android SDK
  - "$ANDROID_HOME"
  # Gradle dependencies
  - "$HOME/.gradle/caches/"
  - "$HOME/.gradle/wrapper/"
  # Android build cache (see http://tools.android.com/tech-docs/build-cache)
  - "$HOME/.android/build-cache"
  # Android AVDs
  - $ANDROID_AVD_HOME
  - $ANDROID_SDK_HOME\avd
  - $HOME\.android\avd
